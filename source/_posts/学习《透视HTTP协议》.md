---
title: 学习《透视HTTP协议》
date: 2021-10-18 12:52:26
urlname:
tags:
---

<img src="https://raw.githubusercontent.com/loshirleyve/images/main/ljf.png?token=ADCW5YRWF7NG3CU7I5D6ZG3BNUUA6">

第0讲：To Be a HTTP Hero
====

你好，我是罗剑锋(Chrono), 一名埋头于前线，辛勤"耕耘"了十余载的资深"码农"。

工作的这十多年来，我开发过智能IC卡，也倒腾过商用密码机；做过政务项目，也做过商务搜索；写过网游核心引擎，也写过CDN存储系统；在Windows上用C/C++做客户端，在 AIX、Linux上用Java、PHP写后台服务……现在则是专注于"魔改"Nginx,深度定制实现网络协议的分析与检测。

当极客时间的编辑联系我，要我写HTTP专栏的时候，我的第一反应是："HTTP协议好简单的，有这个必要吗？"

你可能也会有同样的想法："HTTP不就是请求/响应、GET/POST. Header/Body吗？网络上的资料一抓一大把，有什么问题搜一下就是了。"

不瞒你说，我当时就是这么想的，在之前的工作中也是一直这么做的，而且一直"感觉良好"，觉得HTTP就是这个样子，没有什么特別的地方，没有什么值得讲的。

但在编辑的一再坚持下，我"勉为其难"接下了这个任务。然后做了一个小范围的"调查"，问一些周围的同事，各个领域的都有，比如产品、开发、运维、测试、前端、后端、手机端……想看看他们有什么意见。

出乎我的意料，他们无一例外都对这个"HTTP专栏"有很强烈的需求，想好好“补补课”，系统地学习了解HTTP，这其中甚至还包括有七、八年（甚至更多）工作经验的老手。

这不禁让我陷入了思考，***为什么如此“简单”的协议却还有这么多的人想要学呢？***

我想一个原因可能是 HTTP协议“太常见”了。就像现实中的水和空气一样，如此重要却又如此普遍，普遍到我们几乎忽视了它的存在。真的很像那句俗语所说：“鱼总是最后看见水的”，但水对鱼的生存却又是至关重要。

我认真回忆了一下这些年的工作经历，这才发现HTTP只是表面上显得简单，而底层的运行机制、工作原理绝不简单，可以说是非常地复杂。只是我们平常总是“KPI优先”，网上抓到一个解决方法用过就完事了，没有去深究里面的要点和细节。

下面的几个场景，都是我周围同事的实际感受，你是否也在工作中遇到过这样的困惑呢？你能把它们都解释清楚吗？

- 用 Nginx 搭建 Web 服务器，照着网上的文章配好了，但里面那么多的指令，什么 keepalive、rewrite、proxy_pass 都是怎么回事？为什么要这么配置？
- 用 Python 写爬虫，URI、URL “傻傻分不清楚”，有时里面还会加一些奇怪的字符，怎么处理才好？
- 都说 HTTP 缓存很有用，可以大幅度提升系统性能，可它是怎么做到的？又应该用在何时何地？
- HTTP 和 HTTPS 是什么关系？还经常听说有 SSL/TLS/SNI/OCSP/ALPN……这么多稀奇古怪的缩写，头都大了，实在搞不懂。

其实这些问题也并不是什么新问题，把关键字粘贴进搜索栏，再点一下按钮，搜索引擎马上就能找出几十万个相关的页面。但看完第一页的前几个链接后，通常还是有种“懵懵懂懂” “似懂非懂” 的感觉，觉得说的对，又不全对，和自己的思路叫不够 “Match”。

不过大多数情况下你可能都没有时间细想，优先目标是把手头的工作“对付过去”。长此以来，你对 HTTP 的认识也可能仅限于这样的 “知其然，而不知其所以然”，实际情况就是 HTTP 天天用，时时用，但想认真、系统地学习一下，梳理出自己的知识体系，经常会发现无从下手。

我把这种 HTTP 学习的现状归纳为三点：***正式资料“少”、网上资料“杂”、权限资料“难”。***

第一个，***正式资料“少”***。

上购书网站，搜个 Python、Java，搜个 MySQL、Node.js，能出一大堆。但搜 HTTP，实在是少得可怜，那么几本，一只手的手指头就可以数得过来，和语言类、数据库类、框架类的图书真的是形成了鲜明的对比。

现有的HTTP相关图书我都看过，怎么说呢，它们都有一个特点，"广撒网，捕小鱼"，都是知 识点，可未免太"照本宣科"了，理论有余实践不足，看完了还是不知道怎么去用。

而且这些书的“岁数”都很大，依据的都是20年前的RFC2616,很多内容都不合时宜，而新标准7230已经更新了很多关键的细节。

第二个，网上资料"杂"。

正式的图书少，而且过时，那就求助于网络社区吧。现在的博客、论坛、搜索引擎非常发达，网 上有很多HTTP协议相关的文章，也都是网友的实践经验分享，"干货"很多，很能解决实际问题。

但网上文章的特点是细小、零碎，通常只"钉"在一个很小的知识点上，而且由于帖子长度的限 制，无法深入展开论述，很多都是"浅尝辄止"，通常都止步在"How"层次，很少能说 到"Why",能说透的更是寥寥无几。

网文还有一个难以避免的"毛病"，就是"良莠不齐"。同一个主题可能会有好几种不同的说法，有的还会互相矛盾、以讹传讹。这种情况是最麻烦的，你必须花大力气去鉴别真假，不小心 就会被“带到沟里”。

可想而知，这种"东一榔头西一棒子"的学习方式，用“碎片"拼凑出来的HTTP知识体系是非 常不完善的，会有各种漏洞，遇到问题时基本派不上用场，还得再去找其他的“碎片”。

第三个，权威资料"难”。

图书少，网文杂，我们还有一个终极的学习资料，那就是RFC文档。

RFC是互联网工程组(IETF)发布的官方文件，是对HTTP最权威的定义和解释。但它也是最难 懂的，全英文看着费劲，理解起来更是难上加难，文档之间还会互相关联引用，"劝退率"极高。

这三个问题就像是"三座大山”，阻碍了像你这样的很多有心人去学习、了解HTTP协议。

那么，怎么才能更好地学习HTTP呢?

我为这个专栏定了一个基调：***“要有广度，但更要有深度”***。目标是成为含金量最高的 HTTP 学习资料，新手可以由浅入深、系统学习，老手可以温故知新、查缺补漏，让你花最少的时间，用最少的精力，掌握最多、最全面、最系统的知识。

由于 HTTP 应用得非常广泛，几乎涉及到所有的领域，所以我会在广度上从 HTTP 尽量向外扩展，不只讲协议本身，与它相关的 TCP/IP、DNS、SSL/TLS、Web Server 等都会讲到，而且会把它们打通串联在一起，形成知识链，让你知道它们之间是怎么联系、怎么运行的。

专栏文章的深度上我也是下足了功夫，全部基于最新的 RFC 标准文档，再结合我自己多年的实践体会，力求讲清讲透，能让你看了以后有豁然开朗的感觉。

比如分析 HHTPS，我会用 Wireshark 从建立 TCP 连接时就开始抓包，从二进制最底层来分析里面的 Record、Cipher Suite、Extension，讲 ECDHE、AES、SHA384，再画出详细的流程图，陆游有诗：“***纸上得来终觉浅，绝知此事要躬行***”。学习网络协议最重要的就是实践，在专栏里我还会教你用 Nginx 搭建一个“麻雀虽小，五脏俱全”的实验环境，让你与 HTTP 零距离接触。

它有一个最大的优点：自身就是一个完整的网络环境，即使不联网也能够在里面收发 HTTP 消息。

我还精心设计了配套的测试用例，最小化应用场景，排除干扰因素，你可以在里面任意测试 HTTP的各种特性，再配合Wireshark抓包，就能够理论结合实践，更好地掌握HTTP的知识。

每一讲的末尾，我也会留几个思考题，你可以把它当作是求职时的面试官问题，尽量认真思考后再回答，这样能够把*** 专栏的学习由"被动地听"，转变为"主动地学"，实现"学以致用"。 ***

当然了，你和我的"兴趣点"不可能完全一样，我在汫课时也难免"顾此失彼""挂一漏万"，希望你积极留言，我会视情况做些调整，或者用答疑的形式补充没讲到的内容。

今年是万维网和HTTP诞生30周年，也是HTTP/1.1诞生20周年，套用莎翁《哈姆雷特》里 的名句，让我们在接下来的三个月里一起努力。

***"To Bea HTTP Hero!"***



第一讲：
====
HTTP协议在我们的生活中随处可见，打开手机或者电脑，只要你上网，不论是用iPhone、 Android. Windows还是Mac,不论是用浏览器还是App,不论是看新闻、短视频还是听音 乐、玩游戏，后面总会有HTTP在默默为你服务。

据NetCraft公司统计，目前全球至少有16亿个网站、2亿多个独立域名，而这个庞大网络世界 的底层运转机制就是HTTP。

那么，在享受如此便捷舒适的网络生活时，你有没有想过，***HTTP协议是怎么来的？它最开始是 什么样子的？又是如何一步一步发展到今天，几乎“统治"了整个互联网世界的呢？ ***

常言道：***时势造英雄，英雄亦造时势。***

今天我就和你来聊一聊HTTP的发展历程，看看它的成长轨迹，看看历史上有哪些事件推动了它 的前进，它又促进了哪些技术的产生，一起来见证"英雄之旅"。

在这个过程中，你也能够顺便了解一下HTTP的"历史局限性"，明白HTTP为什么会设计成现 在这个样子。

史前时期
____

20世纪60年代，美国国防部高等研究计划署（ARPA）建立了 ARPA网，它有四个分布在各地 的节点，被认为是如今互联网的"始袓"。

然后在70年代，基于对ARPA网的实践和思考，研究人员发明出了著名的TCP/IP协议。由于具有良好的分层结构和稳定的性能，TCP/IP协议迅速战胜其他竞争对手流行起来，并在80年代中期进入了 UNIX系统内核，促使更多的计算机接入了互联网。

创世纪

<img src="https://gitee.com/liewshirley/mediaAssets/raw/7f986cfe331659fa01cf90b3bb85944231f4084d/%E9%80%8F%E8%A7%86HTTP%E5%8D%8F%E8%AE%AE/li.png">

1989年，任职于欧洲核子研究中心（CERN）的蒂姆.伯纳斯-李（Tim Berners-Lee）发表了一 篇论文，提出了在互联网上构建超链接文档系统的构想。这篇论文中他确立了三项关键技术。

1. URI:即统一资源标识符，作为互联网上资源的唯一身份；
2. HTML:即超文本标记语言，描述超文本文档；
3. HTTP:即超文本传输协议，用来传输超文本。

这三项技术在如今的我们看来已经是稀松平常，但在当时却是了不得的大发明。基于它们，就可以把超文本系统完美地运行在互联网上，让各地的人们能够自由地共享信息，蒂姆把这个系统称 为"万维网"（World Wide Web）,也就是我们现在所熟知的Web。

所以在这一年，我们的英雄"HTTP"诞生了，从此开始了它伟大的征途。

## HTTP/0.9 ##
____

20世纪90年代初期的互联网世界非常简陋，计算机处理能力低，存储容量小，网速很慢，还是 一片"信息荒漠”。网络上绝大多数的资源都是纯文本，很多通信协议也都使用纯文本，所以 HTTP的设计也不可避免地受到了时代的限制。

这一时期的HTTP被定义为0.9版，结构比较简单，为了便于服务器和客户端处理，它也采用了 纯文本格式。蒂姆•伯纳斯-李最初设想的系统里的文档都是只读的，所以只允许用"GET"动作 从服务器上获取HTML文档，并且在响应请求之后立即关闭连接，功能非常有限。

HTTP/0.9虽然很简单，但它作为一个"原型"，充分验证了 Web服务的可行性，而"简单"也 正是它的优点，蕴含了进化和扩展的可能性，因为：

***"把简单的系统变复杂"，要比“把复杂的系统变简单"容易得多。***

## HTTP/1.0 ##
_____

1993年，NCSA （美国国家超级计算应用中心）开发出了 Mosaic,是第一个可以图文混排的浏 览器，随后又在1995年开发出了服务器软件Apache,简化了 HTTP服务器的搭建工作。

同一时期，计算机多媒体技术也有了新的发展：1992年发明了 JPEG图像格式，1995年发明了MP3音乐格式。

这些新软件新技术一经推出立刻就吸引了广大网民的热情, 更多的人开始使用互联网，研究HTTP并提出改进意见，甚至实验性地往协议里添加各种特性，从用户需求的角度促进了HTTP的发展。 

于是在这些已有实践的基础上，经过一系列的草案，HTTP/1.0版本在1996年正式发布。它在多方面增强了0.9版，形式上已经和我们现在的 HTTP 差别不大了，例如：
1. 增加了 HEAD、POST 等新方法；
2. 增加了响应状态码，标记可能的错误原因；
3. 引入了协议版本号概念；
4. 引入了 HTTP Header(头部)的概念，让 HTTP 处理请求和响应更加灵活；
5. 传输的数据不再仅限于文本。

但HTTP/1.0并不是一个“标准”，只是记录已有实践和模式的一份参考文档，不具有实际的约束力，相当于一个“备忘录”。

所以HTTP/1.0的发布对于当时正在蓬勃发展的互联网来说并没有太大的实际意义，各方势力仍然按照自己的意图继续在市场上奋力拼杀。

## HTTP/1.1 ##
_______

1995年，网景的Netscape Navigator和微软的Internet Explorer开始了著名的"浏览器大战"，都希望在互联网上占据主导地位。
<img src="https://gitee.com/liewshirley/mediaAssets/raw/9579ee00351f73320881efdec570bfb58a03a398/%E9%80%8F%E8%A7%86HTTP%E5%8D%8F%E8%AE%AE/pk.png">

这场战争的结果你一定早就知道了，最终微软的IE取得了决定性的胜利，而网景则"败走麦城"（但后来却凭借Mozilla Firefox又扳回一局）。

"浏览器大战"的是非成败我们放在一边暂且不管，不可否认的是，它再一次极大地推动了 Web的发展，HTTP/1.0也在这个过程中经受了实践检验。于是在"浏览器大战"结束之后的1999年，HTTP/1.1发布了 RFC文档，编号为2616,正式确立了延续十余年的传奇。

从版本号我们就可以看到，HTTP/1.1是对HTTP/1.0的小幅度修正。但一个重要的区別是：它是一个“正式的标准”，而不是一份可有可无的“参考文档"。这意味着今后互联网上所有的浏览器、服务器、网关、代理等等，只要用到HTTP协议，就必须严格遵守这个标准，相当于是互联网世界的一个"立法"。

不过，说HTTP/1.1是"小幅度修正"也不太确切，它还是有很多实质性进步的。毕竟经过了多年的实战检验，比起0.9/1.0少了 “学术气”,更加 “接地气”,同时表述也更加严谨。 HTTP/1.1主要的变更点有：
1. 増加了 PUT、DELETE等新的方法；
2. 増加了缓存管理和控制；
3. 明确了连接管理，允许持久连接；
4. 允许响应数据分块（chunked）,利于传输大文件;
5. 强制要求Host头，让互联网主机托管成为可能。

HTTP/1.1的推出可谓是"众望所归"，互联网在它的"保驾护航"下迈开了大步，由此走上 了 "康庄大道"，开启了后续的"Web 1.0" "Web 2.0"时代。现在许多的知名网站都是在这 个时间点左右创立的，例如Google、新浪、搜狐、网易、腾讯等。

不过由于HTTP/1.1太过庞大和复杂，所以在2014年又做了一次修订，原来的一个大文档被拆 分成了六份较小的文档，编号为7230-7235,优化了一些细节，但此外没有任何实质性的改动。

## HTTP/2 ##
_________

HTTP/1.1发布之后，整个互联网世界呈现出了爆发式的増长，度过了十多年的"快乐时光"， 更涌现出了 Facebook、Twitter、淘宝、京东等互联网新贵。

这期间也出现了一些对HTTP不满的意见，主要就是连接慢，无法跟上迅猛发展的互联网，但 HTTP/1.1标准一直“岿然不动”，无奈之下人们只好发明各式各样的"小花招"来缓解这些问 题，比如以前常见的切图、JS合并等网页优化手段。

终于有一天，搜索巨头Google忍不住了，决定“揭竿而起"，就像马云说的“如果银行不改 变，我们就改变银行"。那么，它是怎么"造反"的呢？

Google首先开发了自己的浏览器Chrome,然后推出了新的SPDY协议，并在Chrome里应用于自家的服务器，如同十多年前的网景与微软一样，从实际的用户方来"倒逼" HTTP协议的变革，这也开启了第二次的"浏览器大战"。

历史再次重演，不过这次的胜利者是 Google，Chrome 目前的全球的占有率超过了60%。“挟用户以号令天下”，Google 借此顺势把 SPDY 推上了标准的宝座，互联网标准化组织以 SPDY 为基础开始制定新版本的 HTTP 协议，最终在 2015 年发布了 HTTP/2，RFC 编号 7540.

HTTP/2 的制定充分考虑了现今互联网的现状：宽带、移动、不安全，在高度兼容 HTTP/1.1 的同时在性能改善方面做了很大努力，主要的特点有：
1. 二进制协议，不再是纯文本；
2. 可发起多个请求，废弃了1.1里的管道；
3. 使用专用算法压缩头部，减少数据传输量；
4. 允许服务器主动向客度端推送数据；
5. 增强了安全性，“事实上”要求加密通信。

虽然HTTP/2到今天已经四岁，也衍生出了gRPC等新协议，但由于HTTP/1.1实在是太过经典和强势，目前它的普及率还比较低，大多数网站使用的仍然还是20年前的HTTP/1.1。

## HTTP/3 ##
________

看到这里，你可能会问了：  "HTTP/2这么好，是不是就已经完美了呢？" 

答案是否定的，这一次还是Google,而且它要"革自己的命"。

在HTTP/2还处于草案之时，Google又发明了一个新的协议，叫做QUIC,而且还是相同 的"套路"，继续在Chrome和自家服务器里试验着"玩",依托它的庞大用户量和数据量，持 续地推动QUIC协议成为互联网上的“既成事实"。

"功夫不负有心人”，当然也是因为QUIC确实自身素质过硬。

在去年，也就是2018年，互联网标准化组织IETF提议将"HTTP over QUIC"更名为"HTTP/3"并获得批准，HTTP/3正式进入了标准化制订阶段，也许两三年后就会正式发布， 到时候我们很可能会跳过HTTP/2直接进入HTTP/3。

## 小结 ##
_____________

今天我和你一起跨越了三十年的历史长河，回顾了 HTTP协议的整个发展过程，在这里简单小结 一下今天的内容：

1. HTTP协议始于三十年前蒂姆•伯纳斯-李的一篇论文；
2. HTTP/0.9是个简单的文本协议，只能获取文本资源；
3. HTTP/1.0确立了大部分现在使用的技术，但它不是正式标准；
4. HTTP/1.1是目前互联网上使用最广泛的协议，功能也非常完善；
5. HTTP/2基于Google的SPDY协议，注重性能改善，但还未普及；
6. HTTP/3基于Google的QUIC协议，是将来的发展方向。

希望通过今天的介绍，你能够对HTTP有一个初步但清晰的印象，知道了 "来龙"才能更好地知道"去脉"。

## 课下作业 ##
__________

1. 你认为推动HTTP发展的原动力是什么？
2. 你是怎么理解 HTTP （超文本传输协议）的？

<img src="https://gitee.com/liewshirley/mediaAssets/raw/3194a093ee107f12704c15e343774fb57379fdbe/%E9%80%8F%E8%A7%86HTTP%E5%8D%8F%E8%AE%AE/notice.png">